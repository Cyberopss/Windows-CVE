
# CVE-2020-1350 Vulnerability in Windows Domain Name System (DNS) Server


## Introduction


SIGRed, CVE-2020-1350, is a vulnerability in the Microsoft Windows DNS service that was disclosed on July 14, 2020. It was discovered by Sagi Tzadik. The vulnerability received a CVSS score of 10.0, the highest level of severity. On Windows, a DNS server is a Domain Controller, and its Administrators are part of the Domain Admins group. By default, the Domain Admins group is a member of the Administrators group on all computers that have joined a domain, including the domain controllers. If exploited carefully, attackers can perform denial of service attack on the vulnerable system and interrupting the dns service, effectively affecting the entire corporate infrastructure.

## Description of Vulnerability

CVE-2020-1350 is an integer overflow vulnerability that leads to a heap-based buffer overflow when processing malformed DNS SIG resource records. A SIG record is a type of DNS resource record that contains a digital signature for a record set(one or more DNS records with the same name and type). To exploit SIGRed, an attacker can configure an “evil” domain whose NS record points to a malicious DNS server. When a client makes a DNS query for the “evil” domain to the victim server, the victim server will query the DNS server above it. The DNS server will respond back with an NS record indicating that the malicious DNS server is the authority for that domain, and the record will be cached by the victim. Afterwards, when a client sends the victim a DNS SIG query for the domain, the victim server will query the malicious DNS server. The malicious DNS server will send a malformed DNS SIG record as a response.

The vulnerability is present in the function dns!SigWireRead (in the DNS service binary, dns.exe), which is used to cache a DNS SIG record response from another DNS server.

The function RR_AllocateEx is passed a 16-bit unsigned integer for the size parameter. It is possible to send a DNS SIG record response such that size calculated is greater than 0xFFFF, which triggers the integer overflow.

## Windows affected versions

The affected versions of Windows Server that were vulnerable to CVE-2020-1350 include:

* Windows Server 2003
* Windows Server 2008
* Windows Server 2008 R2
* Windows Server 2012
* Windows Server 2012 R2
* Windows Server 2016
* Windows Server 2019

The patch number for the Microsoft security update that addressed CVE-2020-1350 (SIGRed) is as follows:

For Windows Server 2016: The patch number is KB4565529

## The existence of the vulnerability in the wild

Windows DNS Server is a core component of each Windows-based environment and it’s also commonly used within Active Directory. Besides, the vulnerability was tagged as “wormable”, meaning that, after exploitation, the attacker can perform lateral and vertical movements through your network, leading to a potential full compromise.

At the time of writing, there were about 23,244 possible vulnerable targets registered through Shodan

## Require tools and operating system

* Oracle VM Virtual Box
* Attacker machine: Ubuntu Linux 22.04
* Target machine: Windows server 2016
* Stable internet access
* Python
* Text editor (Notepad, Visual Studio Code, IDLE for Python etc.)

## Setting up Attacker and Target Machine

For attacker machine install ubuntu as a VM
The target system is specified as Windows server 2016.
The project needs the target firewall and auto-update turned off. 

So, we have to set up the dns server in the windows server machine

1. Open Server Manager and Add Roles and Features
2. Select "Role-based installation"
3. Select Server to install DNS into and hit “Next“ 
4. Select DNS Server and Add Features
5. Confirm your selections then hit “Install“

Dns server is now set up

Now open the DNS manager and set a forward lookup zone with zone name as lol under primary zone

![2](https://github.com/Cyberopss/Windows-CVE/blob/main/CVE-2020-1350/images/1.jpg)
![2](https://github.com/Cyberopss/Windows-CVE/blob/main/CVE-2020-1350/images/2.jpg)
![2](https://github.com/Cyberopss/Windows-CVE/blob/main/CVE-2020-1350/images/3.jpg)

Now make a new delegated zone with the name of hex and add the nameserver with the ip address of Attacker machine

![2](https://github.com/Cyberopss/Windows-CVE/blob/main/CVE-2020-1350/images/4.jpg)
![2](https://github.com/Cyberopss/Windows-CVE/blob/main/CVE-2020-1350/images/5.jpg)

## Attacker Machine (Ubuntu VM)
* The network setting is set to Bridged Adapter mode.

## Victim Machine (Windows VM)
* The network setting is set to Bridged Adapter mode.

## Vulnerability detection
Without actually crashing or modifying the target system, it is important to determine whether the target computer is still vulnerable to this exploit. To do this, we can run an nmap on target system to find whether port 53 is open which is for dns.
Running the detection script on target machine, it wil tell whether the patch is applied and the system is vulnerable or not.

## Running the Scanner script
It consists a checker batch script and we have to execute that on windows PowerShell. On executing this command will show the result as ‘Vulnerable’

![2](https://github.com/Cyberopss/Windows-CVE/blob/main/CVE-2020-1350/images/6.jpg)


## Working of script
The script checks whether the server is vulnerable to the CVE-2020-1350 vulnerability by examining specific conditions and registry settings related to the Windows DNS Service. Here's how the script determines if the server is vulnerable:

### Check for the Windows DNS Service:
The script begins by checking if the Windows DNS Service is running on the server using the `CheckForDNSServer` function. It looks for a service with the name containing "DNS." If the service is running, it assumes that the server is acting as a Windows DNS Server

### Check Windows Version and Updates
The script identifies the Windows version using the `CheckIfUpdateIsInstalled` function by reading the "ProductName" registry value. Depending on the detected Windows version, it checks for specific security updates or monthly rollups that have been installed. The script verifies this by using the `Get-HotFix` cmdlet to look for specific update IDs associated with the detected Windows version. If the necessary updates are installed, it concludes that the server is not vulnerable

### Check the TcpReceivePacketSize Registry Setting
To determine if the server is vulnerable, the script uses the `CheckRegDNS` function to examine the `TcpReceivePacketSize` registry value.If the `TcpReceivePacketSize` value exists and is set to "0xFF00" and is of the type "DWORD," it indicates that the workaround has been applied, and the server is not vulnerable. If the `TcpReceivePacketSize` value is not found in the registry, it assumes that the workaround has not been applied, and the server is potentially vulnerable

## Exploiting the vulnerability

The next step is to perform the dos attack by running the POC script

Following is the IP address of Victim and attacker machine

![2](https://github.com/Cyberopss/Windows-CVE/blob/main/CVE-2020-1350/images/7.jpg)
![2](https://github.com/Cyberopss/Windows-CVE/blob/main/CVE-2020-1350/images/8.jpg)

Following is the screenshot that dns service is running on victim machine

![2](https://github.com/Cyberopss/Windows-CVE/blob/main/CVE-2020-1350/images/10.jpg)

## Change the dns server ip on python POC script

We have to replace the dns server ip with the attacker machine ip as we have set the attacker machine as nameserver for forward lookup zone

![2](https://github.com/Cyberopss/Windows-CVE/blob/main/CVE-2020-1350/images/11.jpg)

### Exploitation

With everything prepared, run the code with command 
```
‘python3 ./exploit.py 9.hax.lol’ 
```
on the attacker machine.

![2](https://github.com/Cyberopss/Windows-CVE/blob/main/CVE-2020-1350/images/12.jpg)

Expected outcome:
If all goes well, the dns services on the windows server machine will stop

![2](https://github.com/Cyberopss/Windows-CVE/blob/main/CVE-2020-1350/images/13.jpg)

## Mitigation Techniques
A registry-based workaround can be used to help protect an affected Windows server, and it can be implemented without requiring an administrator to restart the server.

To work around this vulnerability, make the following registry change to restrict the size of the largest inbound TCP-based DNS response packet that's allowed:
```
reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\DNS\ Parameters" /v "TcpReceivePacketSize" /t REG_DWORD /d 0xFF00 /f
```
```
net stop DNS && net start DNS
```
